<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Stpm2 on Paul C. Lambert</title>
    <link>/tags/stpm2/</link>
    <description>Recent content in Stpm2 on Paul C. Lambert</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>&amp;copy; 2017 Paul C Lambert</copyright>
    <lastBuildDate>Mon, 21 Aug 2017 00:00:00 +0000</lastBuildDate>
    <atom:link href="/tags/stpm2/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>stpm2</title>
      <link>/software/stpm2/</link>
      <pubDate>Mon, 21 Aug 2017 00:00:00 +0000</pubDate>
      
      <guid>/software/stpm2/</guid>
      <description>

&lt;p&gt;&lt;code&gt;stpm2&lt;/code&gt; fits flexible parametric survival models. These models use splines to model some transformation of the survial function. The most common is the  $\log[-\log[S(t)]]$ link function, which fits proportional hazards models.&lt;/p&gt;

&lt;p&gt;I have added some examples and aim to add to these.&lt;/p&gt;

&lt;h2 id=&#34;proportional-hazards-models&#34;&gt;Proportional hazards models&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;/software/stpm2/comparewithcox/&#34;&gt;Comparison with a Cox model&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;simple simulation study to show agreement with Cox model.&lt;/li&gt;
&lt;li&gt;predicting hazard and survival functions (use of the &lt;code&gt;timevar()&lt;/code&gt; option)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;/software/stpm2/sensitivity_analysis/&#34;&gt;Sensitivity analysis for the number of knots&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;time-dependent-effects-non-proportional-hazards&#34;&gt;Time-dependent effects (non proportional hazards)&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;non-proportional hazards&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;relative-survival&#34;&gt;Relative survival&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;a simple relative survival model&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;alternative-link-functions&#34;&gt;Alternative link functions&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;the logistic, probit and Aranda-Ordaz link functions.&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Proportional hazards models in stpm2</title>
      <link>/software/stpm2/comparewithcox/</link>
      <pubDate>Sun, 06 Aug 2017 00:00:00 +0000</pubDate>
      
      <guid>/software/stpm2/comparewithcox/</guid>
      <description>

&lt;h1 id=&#34;proportional-hazards-model&#34;&gt;Proportional hazards model&lt;/h1&gt;

&lt;p&gt;We first load the example breast cancer data data using &lt;code&gt;webuse&lt;/code&gt; and then use &lt;code&gt;stset&lt;/code&gt; to declare the survival time and event indicator.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. webuse brcancer, clear
(German breast cancer data)

. stset rectime, f(censrec==1) scale(365.24)

     failure event:  censrec == 1
obs. time interval:  (0, rectime]
 exit on or before:  failure
    t for analysis:  time/365.24

------------------------------------------------------------------------------
        686  total observations
          0  exclusions
------------------------------------------------------------------------------
        686  observations remaining, representing
        299  failures in single-record/single-failure data
  2,112.036  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =  7.280145

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;scale(365.25)&lt;/code&gt; option converts the times recorded in days to years.&lt;/p&gt;

&lt;p&gt;A standard Cox proportional hazards model can be defined as follows,&lt;/p&gt;

&lt;p&gt;$$
h_i(t|\mathbf{x}_i)=h_0(t)\exp\left(\mathbf{x}_i\boldsymbol{\beta}\right)
$$&lt;/p&gt;

&lt;p&gt;A key point about the Cox model is that we do not estimate the baseline hazard, $h_0(t)$, as this cancels out in the partial likelihood, so we only estimate the relative effects, i.e. hazard ratios.&lt;/p&gt;

&lt;p&gt;We can now fit a Cox model in Stata with &lt;code&gt;hormon&lt;/code&gt; as the only covariate.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. stcox hormon, 

         failure _d:  censrec == 1
   analysis time _t:  rectime/365.24

Iteration 0:   log likelihood = -1788.1731
Iteration 1:   log likelihood =  -1783.774
Iteration 2:   log likelihood =  -1783.765
Iteration 3:   log likelihood =  -1783.765
Refining estimates:
Iteration 0:   log likelihood =  -1783.765

Cox regression -- Breslow method for ties

No. of subjects =          686                  Number of obs    =         686
No. of failures =          299
Time at risk    =  2112.035922
                                                LR chi2(1)       =        8.82
Log likelihood  =    -1783.765                  Prob &amp;gt; chi2      =      0.0030

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P&amp;gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      hormon |   .6949616   .0869009    -2.91   0.004      .543905    .8879705
------------------------------------------------------------------------------

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We will now fit a flexible parametric survival model. Here are model is on the log &lt;em&gt;cumulative&lt;/em&gt; hazard scale, so our model is defined using uppercase H rather than lowercase h.&lt;/p&gt;

&lt;p&gt;$$
H_i(t|\mathbf{x}_i)=H_0(t)\exp\left(\mathbf{x}_i\boldsymbol{\beta}\right)
$$&lt;/p&gt;

&lt;p&gt;Do we have to worry about the switch from hazard function to cumulative hazard function? Well, the answer is &amp;ldquo;No&amp;rdquo; as if we have proportional hazards we also have proportional cumulative hazards.&lt;/p&gt;

&lt;p&gt;In the flexible parametric survival model we estimate the baseline using restriced cubic splines. So we need additional parameters to estimate the baseline (the log cumulative hazard in this case).  The linear predictor is,&lt;/p&gt;

&lt;p&gt;$$
\ln[H(t|\mathbf{x}_i)] = \eta_i(t) = s\left(\ln(t)|\boldsymbol{\gamma}, \mathbf{k}_{0}\right) + \mathbf{x}_i \boldsymbol{\beta}
$$&lt;/p&gt;

&lt;p&gt;where $s\left(\ln(t)|\boldsymbol{\gamma}, \mathbf{k}_{0}\right)$ is a restriced cubic spline function of log(time).&lt;/p&gt;

&lt;p&gt;We now fit this model in Stata using &lt;code&gt;stpm2&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. stpm2 hormon, df(3) scale(hazard) eform

Iteration 0:   log likelihood = -671.75275  
Iteration 1:   log likelihood = -670.39949  
Iteration 2:   log likelihood = -670.39239  
Iteration 3:   log likelihood = -670.39239  

Log likelihood = -670.39239                     Number of obs     =        686

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P&amp;gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
      hormon |   .6966754   .0870015    -2.89   0.004     .5454206    .8898757
       _rcs1 |   4.931928   .6329089    12.43   0.000     3.835156    6.342354
       _rcs2 |   1.786812   .2092654     4.96   0.000     1.420329    2.247857
       _rcs3 |   .9519031     .03275    -1.43   0.152     .8898306    1.018306
       _cons |   .3032836   .0247012   -14.65   0.000     .2585366    .3557753
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I have used three options. The &lt;code&gt;df(3)&lt;/code&gt; option requests there to be 3 restricted cubic spline parameters (4 knots). These are at the default knot locations, which are at evenly spaced centiles of the uncensored event times. The &lt;code&gt;scale()&lt;/code&gt; option defines the link function and &lt;code&gt;scale(hazard)&lt;/code&gt; asks for a log(-log) link function, i.e. our linear predictor is on the log cumulative hazard scale. The &lt;code&gt;eform&lt;/code&gt; option means that the coefficients will be exponentiated.&lt;/p&gt;

&lt;p&gt;The key point here is the similarity between the hazard ratios form the two models. This is nearly always the case. I will try to convince anyone who does not believe this in future posts.&lt;/p&gt;

&lt;p&gt;A sensible question is, &lt;em&gt;if we get the same anwers, why not just fit a Cox model&lt;/em&gt;?  Well, if all you want is a single hazard ratio and proportional hazards is a reasonable assumption then I agree with you. However, as I will show in other examples, there are many advantages of the parametric approach.&lt;/p&gt;

&lt;p&gt;There are a number of issues that people may raise. This include how many knots to use and where to put the knots. I will cover these in future tutorials.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Sensitivity analysis to number of knots (proportional hazards)</title>
      <link>/software/stpm2/sensitivity_analysis/</link>
      <pubDate>Sun, 06 Aug 2017 00:00:00 +0000</pubDate>
      
      <guid>/software/stpm2/sensitivity_analysis/</guid>
      <description>

&lt;h1 id=&#34;sensitivity-analysis&#34;&gt;Sensitivity Analysis&lt;/h1&gt;

&lt;p&gt;We first load the example Rotterdam breast cancer data (rott2b.dta)  and then use &lt;code&gt;stset&lt;/code&gt; to declare the survival time (relapse free survival) and event indicator. Follow-up is restricted to 5 years using the &lt;code&gt;exit()&lt;/code&gt; option.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. use https://www.pclambert.net/data/rott2b, clear
(Rotterdam breast cancer data (augmented with cause of death))

. stset rf, f(rfi==1) scale(12) exit(time 60)

     failure event:  rfi == 1
obs. time interval:  (0, rf]
 exit on or before:  time 60
    t for analysis:  time/12

------------------------------------------------------------------------------
      2,982  total observations
          0  exclusions
------------------------------------------------------------------------------
      2,982  observations remaining, representing
      1,181  failures in single-record/single-failure data
 11,130.825  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =         5

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I will use different degrees of freedom for the baseline. The easiest way to do this is in a loop. The following code fits between 1 and 6 df, predicts the baseline hazard and survival functions and stores each model (using &lt;code&gt;estimates store&lt;/code&gt;).  I use &lt;code&gt;quietly&lt;/code&gt; to suppress the output. I also generate a new time variable (&lt;code&gt;temptime&lt;/code&gt;) for the predictions, rather than use the default of &lt;code&gt;_t&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. range temptime 0 5 200
(2,782 missing values generated)

. forvalues i = 1/6 {
  2.         quietly stpm2 hormon, df(`i&#39;) scale(hazard) 
  3.         predict h0_df`i&#39;, hazard timevar(temptime) per(1000) zeros
  4.         predict s0_df`i&#39;, survival timevar(temptime) zeros
  5.         estimates store df`i&#39;
  6. }

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can now compare the results from fitting the 6 different models.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. estimates table df*, keep(hormon) b(%6.5f) se(%6.5f) stats(AIC BIC) stfmt(%6.2f)

--------------------------------------------------------------------------
    Variable |   df1       df2       df3       df4       df5       df6    
-------------+------------------------------------------------------------
      hormon | 0.23312   0.22044   0.22038   0.22023   0.22020   0.22007  
             | 0.08642   0.08643   0.08643   0.08643   0.08643   0.08643  
-------------+------------------------------------------------------------
         AIC | 6362.72   6210.98   6212.43   6213.72   6213.75   6215.98  
         BIC | 6377.94   6231.28   6237.80   6244.17   6249.27   6256.57  
--------------------------------------------------------------------------
                                                              legend: b/se

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The log hazard ratios are very similar between the different models, particularly from 2df and above (using 1 df is equivalent to fitting a Weibull model). The standard errors are also very similar.&lt;/p&gt;

&lt;p&gt;The AIC and BIC can be used as an &lt;em&gt;informal&lt;/em&gt; guide (certainly not definitive) to the choice of model.  Both the AIC and BIC are lowest for the model with 2df.&lt;/p&gt;

&lt;p&gt;One of the advantages of using parametric models is the simplicity in which we can predict hazard, survival and other useful functions. In the loop when the 6 different models were fitted the baseline hazard and survival functions were also obtained. We can now compare these by plotting them.&lt;/p&gt;

&lt;p&gt;First, the baseline hazard functions. Note I used the &lt;code&gt;per(1000)&lt;/code&gt; option when I predicted the hazard functions to give the rate per 1000 person years.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. twoway  (line h0_df* temptime), ///
&amp;gt;                 ytitle(&amp;quot;hazard rate (per 1000 py)&amp;quot;) ///
&amp;gt;                 xtitle(&amp;quot;Years from surgery&amp;quot;) ///
&amp;gt;                 ylabel(,format(%2.0f) angle(h)) ///
&amp;gt;                 legend(order(1 &amp;quot;1 df&amp;quot; 2 &amp;quot;2 df&amp;quot; 3 &amp;quot;3df&amp;quot; 4 &amp;quot;4df&amp;quot; 5 &amp;quot;5df&amp;quot; 6 &amp;quot;6df&amp;quot;) ///
&amp;gt;                         ring(0) cols(1) pos(5))

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The graph is shown below. The model with 1 df (equivalent to a Weibull model) stands out. The hazard function for the Weibull model is monotonic and so can&amp;rsquo;t pick up the turning point. There is fairly good agreement between the other models. Remember that the AIC and BIC indicate that models with 3df or more are over fitting.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/statasvg/ph_sensitivity_hazard.svg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Now, using similar code we can plot the six baseline survival functions.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-stata&#34;&gt;. twoway  (line s0_df* temptime), ///
&amp;gt;                 ytitle(&amp;quot;Survival function - S(t)&amp;quot;) ///
&amp;gt;                 xtitle(&amp;quot;Years from surgery&amp;quot;) ///
&amp;gt;                 ylabel(,format(%3.1f) angle(h)) ///
&amp;gt;                 legend(order(1 &amp;quot;1 df&amp;quot; 2 &amp;quot;2 df&amp;quot; 3 &amp;quot;3df&amp;quot; 4 &amp;quot;4df&amp;quot; 5 &amp;quot;5df&amp;quot; 6 &amp;quot;6df&amp;quot;) ///
&amp;gt;                         ring(0) cols(1) pos(1))

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This graph is shown below and again the model with 1 df stands out, which is not surprising given the hazard function. However, there is excellent agreement between the remaining 5 models. In general, one sees better agreement when comparing survival functions as it is a cumulative measure the small differences seen the hazard functions cancel out.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/statasvg/ph_sensitivity_survival.svg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;This has been a simple sensitivity analysis where I have assumed proportional hazards and only fitted a single covariate, but I hope that it shows how simple it is to try these things.&lt;/p&gt;

&lt;p&gt;What I see as the key point here is that even when selecting a too complex model (as indicated by the AIC and BIC) it makes little difference to the hazard ratio or the estimated hazard and survival functions. Of course one could argue that this is a single data set, but see Rutherord &lt;em&gt;et al.&lt;/em&gt; for a more detailed simulation study on the ability of these models to capture complex hazard functions.&lt;/p&gt;

&lt;h3 id=&#34;references&#34;&gt;References&lt;/h3&gt;

&lt;p&gt;Rutherford M.J., Crowther M.J., Lambert, P.C. The use of restricted cubic splines to approximate complex hazard functions in the analysis of time-to-event data: a simulation study. &lt;em&gt;Journal of Statistical Computation and Simulation&lt;/em&gt; 2015;&lt;strong&gt;4&lt;/strong&gt;:777–793&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
